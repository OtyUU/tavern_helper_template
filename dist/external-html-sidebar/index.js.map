{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/external-html-sidebar/index.ts","src://tavern_helper_template/src/util/script.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","import { deteleportStyle, teleportStyle } from '../util/script';\nimport jquerySource from 'jquery/dist/jquery.min.js?raw';\nimport lodashSource from 'lodash/lodash.min.js?raw';\nimport { z } from 'zod';\n\nconst SIDEBAR_ID = 'tavern-helper-external-html-sidebar';\nconst SIDEBAR_WIDTH = '500px';\n\n// Zod schema for settings\nconst SettingsSchema = z.object({\n  mode: z.enum(['url', 'paste']).default('url'),\n  url: z.string().min(1).default('about:blank'),\n  pasteContent: z.string().default(''),\n});\n\ntype Settings = z.infer<typeof SettingsSchema>;\n\nconst HOST_BRIDGE_KEY = '__tavern_helper_external_html_sidebar_bridge__';\n\nlet sidebarVisible = false;\nlet currentBlobUrl: string | null = null;\n\nfunction installHostBridge(): void {\n  try {\n    if (!window.parent) return;\n\n    (window.parent as any)[HOST_BRIDGE_KEY] = {\n      getGlobal: (name: string) => (globalThis as any)[name],\n      getCurrentMessageId: () => {\n        const getLastMessageId = (globalThis as any).getLastMessageId as undefined | (() => number);\n        if (typeof getLastMessageId === 'function') return getLastMessageId();\n\n        const chat = (globalThis as any).SillyTavern?.chat;\n        if (Array.isArray(chat)) return Math.max(0, chat.length - 1);\n\n        return 0;\n      },\n    };\n  } catch {\n    // ignore\n  }\n}\n\nfunction escapeInlineScript(source: string): string {\n  return source.replaceAll('</script', '<\\\\/script');\n}\n\nfunction setSidebarIframeSrc(src: string): void {\n  if (currentBlobUrl) {\n    URL.revokeObjectURL(currentBlobUrl);\n    currentBlobUrl = null;\n  }\n\n  if (src.startsWith('blob:')) {\n    currentBlobUrl = src;\n  }\n\n  $(`#${SIDEBAR_ID}-iframe`).attr('src', src);\n}\n\nfunction buildRuntimeWrappedHtml(html: string): string {\n  const parser = new DOMParser();\n  const doc = parser.parseFromString(html, 'text/html');\n\n  if (!doc.head) {\n    const head = doc.createElement('head');\n    doc.documentElement.insertBefore(head, doc.body);\n  }\n\n  if (!doc.head.querySelector('meta[charset]')) {\n    const meta = doc.createElement('meta');\n    meta.setAttribute('charset', 'UTF-8');\n    doc.head.prepend(meta);\n  }\n\n  const runtimeShim = `\n(() => {\n  const BRIDGE_KEY = ${JSON.stringify(HOST_BRIDGE_KEY)};\n  const bridge = (() => {\n    try {\n      return window.parent && window.parent[BRIDGE_KEY];\n    } catch {\n      return undefined;\n    }\n  })();\n\n  const missing = name => () => {\n    throw new Error(\n      '[external-html-sidebar] Missing runtime global: ' +\n        name +\n        '. This page must be rendered inside SillyTavern with Tavern Helper + external-html-sidebar.',\n    );\n  };\n\n  const getGlobal = name => (bridge && bridge.getGlobal ? bridge.getGlobal(name) : undefined);\n\n  const bridgeFn = name => (...args) => {\n    const fn = getGlobal(name);\n    if (typeof fn !== 'function') return missing(name)();\n    return fn(...args);\n  };\n\n  const syncGlobal = name => {\n    try {\n      const value = getGlobal(name);\n      if (typeof value !== 'undefined' && typeof window[name] === 'undefined') {\n        window[name] = value;\n      }\n    } catch {\n      // ignore\n    }\n  };\n\n  if (typeof window.waitGlobalInitialized !== 'function') {\n    window.waitGlobalInitialized = async name => {\n      await bridgeFn('waitGlobalInitialized')(name);\n      syncGlobal(name);\n    };\n  }\n  if (typeof window.getAllVariables !== 'function') window.getAllVariables = bridgeFn('getAllVariables');\n  if (typeof window.getVariables !== 'function') window.getVariables = bridgeFn('getVariables');\n  if (typeof window.replaceVariables !== 'function') window.replaceVariables = bridgeFn('replaceVariables');\n  if (typeof window.triggerSlash !== 'function') window.triggerSlash = bridgeFn('triggerSlash');\n  if (typeof window.eventOn !== 'function') window.eventOn = bridgeFn('eventOn');\n  if (typeof window.getButtonEvent !== 'function') window.getButtonEvent = bridgeFn('getButtonEvent');\n  if (typeof window.replaceScriptButtons !== 'function') window.replaceScriptButtons = bridgeFn('replaceScriptButtons');\n\n  if (typeof window.errorCatched !== 'function') {\n    window.errorCatched = fn => (...args) => {\n      try {\n        const result = fn(...args);\n        if (result && typeof result.then === 'function') {\n          return result.catch(err => {\n            console.error(err);\n            throw err;\n          });\n        }\n        return result;\n      } catch (err) {\n        console.error(err);\n        throw err;\n      }\n    };\n  }\n\n  syncGlobal('SillyTavern');\n  syncGlobal('toastr');\n  syncGlobal('Mvu');\n  syncGlobal('tavern_events');\n  syncGlobal('z');\n  syncGlobal('gsap');\n  syncGlobal('YAML');\n\n  if (typeof window.getCurrentMessageId !== 'function') {\n    window.getCurrentMessageId = () => {\n      try {\n        if (bridge && typeof bridge.getCurrentMessageId === 'function') {\n          return bridge.getCurrentMessageId();\n        }\n      } catch {\n        // ignore\n      }\n\n      try {\n        const chat = window.SillyTavern && window.SillyTavern.chat;\n        if (Array.isArray(chat)) return Math.max(0, chat.length - 1);\n      } catch {\n        // ignore\n      }\n\n      return 0;\n    };\n  }\n})();\n`;\n\n  const scriptJquery = doc.createElement('script');\n  scriptJquery.textContent = escapeInlineScript(jquerySource);\n\n  const scriptLodash = doc.createElement('script');\n  scriptLodash.textContent = escapeInlineScript(lodashSource);\n\n  const scriptShim = doc.createElement('script');\n  scriptShim.textContent = escapeInlineScript(runtimeShim);\n\n  doc.head.prepend(scriptJquery, scriptLodash, scriptShim);\n\n  return `<!DOCTYPE html>\\n${doc.documentElement.outerHTML}`;\n}\n\nfunction getSettings(): Settings {\n  try {\n    const vars = getVariables({ type: 'script' });\n    return SettingsSchema.parse(vars);\n  } catch (e) {\n    return SettingsSchema.parse({});\n  }\n}\n\nfunction saveSettings(settings: Settings) {\n  replaceVariables(settings, { type: 'script' });\n}\n\nfunction injectCSS(): void {\n  const css = `\n    #${SIDEBAR_ID} {\n      position: fixed;\n      top: 0;\n      right: 0;\n      width: ${SIDEBAR_WIDTH};\n      height: 100vh;\n      background: rgba(29, 33, 40, 0.95);\n      backdrop-filter: blur(5px);\n      border-left: 0.5px solid rgba(0, 0, 0, 0.5);\n      border-top-left-radius: 12px;\n      border-bottom-left-radius: 12px;\n      z-index: 999999;\n      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      transform: translateX(100%);\n      display: flex;\n      flex-direction: column;\n      color: rgba(207, 207, 197, 1);\n      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;\n    }\n\n    #${SIDEBAR_ID}.visible {\n      transform: translateX(0);\n    }\n\n    #${SIDEBAR_ID} .header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      padding: 0 20px;\n      height: 50px;\n      background: rgba(29, 33, 40, 0.98);\n      border-bottom: 0.5px solid rgba(0, 0, 0, 0.8);\n      border-top-left-radius: 12px;\n      flex-shrink: 0;\n    }\n\n    #${SIDEBAR_ID} .header h3 {\n      margin: 0;\n      font-size: 16px;\n      font-weight: 500;\n    }\n\n    #${SIDEBAR_ID} .close-btn {\n      background: rgba(29, 33, 40, 0.6);\n      border: 0.5px solid rgba(0, 0, 0, 0.8);\n      color: rgba(207, 207, 197, 0.9);\n      cursor: pointer;\n      padding: 5px 12px;\n      border-radius: 8px;\n      font-size: 20px;\n      transition: all 0.2s ease;\n      line-height: 1;\n    }\n\n    #${SIDEBAR_ID} .close-btn:hover {\n      background: rgba(40, 45, 52, 0.8);\n      color: #fff;\n    }\n\n    #${SIDEBAR_ID} .content {\n      flex: 1;\n      overflow: hidden;\n      position: relative;\n    }\n\n    #${SIDEBAR_ID} iframe {\n      width: 100%;\n      height: 100%;\n      border: none;\n      background: transparent;\n    }\n\n    #${SIDEBAR_ID} .footer {\n      padding: 10px 15px;\n      background: rgba(29, 33, 40, 0.98);\n      border-top: 0.5px solid rgba(0, 0, 0, 0.8);\n      display: flex;\n      gap: 8px;\n      flex-shrink: 0;\n    }\n\n    #${SIDEBAR_ID} .url-input {\n      flex: 1;\n      background: rgba(0, 0, 0, 0.3);\n      border: 0.5px solid rgba(255, 255, 255, 0.1);\n      border-radius: 6px;\n      color: #fff;\n      padding: 6px 10px;\n      font-size: 12px;\n      outline: none;\n    }\n\n    #${SIDEBAR_ID} .load-btn {\n      background: #4a5568;\n      border: none;\n      border-radius: 6px;\n      color: #fff;\n      padding: 6px 12px;\n      font-size: 12px;\n      cursor: pointer;\n      transition: background 0.2s;\n    }\n\n    #${SIDEBAR_ID} .load-btn:hover {\n      background: #2d3748;\n    }\n\n    #${SIDEBAR_ID} .mode-toggle {\n      display: flex;\n      background: rgba(0, 0, 0, 0.3);\n      border-radius: 6px;\n      padding: 2px;\n      margin-bottom: 8px;\n    }\n\n    #${SIDEBAR_ID} .mode-option {\n      flex: 1;\n      background: transparent;\n      border: none;\n      color: #aaa;\n      padding: 6px 12px;\n      border-radius: 4px;\n      font-size: 12px;\n      cursor: pointer;\n      transition: all 0.2s;\n    }\n\n    #${SIDEBAR_ID} .mode-option.active {\n      background: #4a5568;\n      color: #fff;\n    }\n\n    #${SIDEBAR_ID} .mode-content {\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n      flex: 1;\n    }\n\n    #${SIDEBAR_ID} .paste-container {\n      display: none;\n      flex-direction: column;\n      gap: 8px;\n    }\n\n    #${SIDEBAR_ID} .paste-container.active {\n      display: flex;\n    }\n\n    #${SIDEBAR_ID} .url-container {\n      display: none;\n      gap: 8px;\n    }\n\n    #${SIDEBAR_ID} .url-container.active {\n      display: flex;\n    }\n\n    #${SIDEBAR_ID} .paste-textarea {\n      flex: 1;\n      background: rgba(0, 0, 0, 0.3);\n      border: 0.5px solid rgba(255, 255, 255, 0.1);\n      border-radius: 6px;\n      color: #fff;\n      padding: 8px;\n      font-size: 12px;\n      font-family: 'Courier New', monospace;\n      resize: vertical;\n      min-height: 60px;\n      outline: none;\n    }\n\n    #${SIDEBAR_ID} .paste-textarea:focus {\n      border-color: #4a5568;\n    }\n\n    #${SIDEBAR_ID} .render-btn {\n      background: #4a5568;\n      border: none;\n      border-radius: 6px;\n      color: #fff;\n      padding: 6px 12px;\n      font-size: 12px;\n      cursor: pointer;\n      transition: background 0.2s;\n    }\n\n    #${SIDEBAR_ID} .render-btn:hover {\n      background: #2d3748;\n    }\n  `;\n  $('<style>').text(css).appendTo('head');\n  teleportStyle();\n}\n\nfunction injectHTML(): void {\n  if ($(`#${SIDEBAR_ID}`).length > 0) return;\n\n  const settings = getSettings();\n  const mode = settings.mode || 'url';\n  const html = `\n    <div id=\"${SIDEBAR_ID}\">\n      <div class=\"header\">\n        <div style=\"display: flex; align-items: center; gap: 8px;\">\n          <span style=\"font-size: 18px;\">üåê</span>\n          <h3>External Interface</h3>\n        </div>\n        <button class=\"close-btn\" id=\"${SIDEBAR_ID}-close\" title=\"Close\">√ó</button>\n      </div>\n      <div class=\"content\">\n        <iframe id=\"${SIDEBAR_ID}-iframe\" src=\"${settings.url}\"></iframe>\n      </div>\n      <div class=\"footer\">\n        <div class=\"mode-toggle\">\n          <button class=\"mode-option ${mode === 'url' ? 'active' : ''}\" data-mode=\"url\">URL</button>\n          <button class=\"mode-option ${mode === 'paste' ? 'active' : ''}\" data-mode=\"paste\">Paste Code</button>\n        </div>\n        <div class=\"mode-content\">\n          <div class=\"url-container ${mode === 'url' ? 'active' : ''}\">\n            <input type=\"text\" class=\"url-input\" id=\"${SIDEBAR_ID}-url-input\" value=\"${settings.url === 'about:blank' ? '' : settings.url}\" placeholder=\"Enter HTML URL (e.g. ./panel/index.html)...\">\n            <button class=\"load-btn\" id=\"${SIDEBAR_ID}-load-btn\">Load</button>\n          </div>\n          <div class=\"paste-container ${mode === 'paste' ? 'active' : ''}\">\n            <textarea class=\"paste-textarea\" id=\"${SIDEBAR_ID}-paste-textarea\" placeholder=\"Paste your HTML/CSS/JS code here...\">${settings.pasteContent}</textarea>\n            <button class=\"render-btn\" id=\"${SIDEBAR_ID}-render-btn\">Render</button>\n          </div>\n        </div>\n      </div>\n    </div>\n  `;\n  $('body').append(html);\n\n  $(`#${SIDEBAR_ID}-close`).on('click', () => toggleSidebar(false));\n\n  // Mode toggle functionality\n  $(`.mode-option`).on('click', function () {\n    const selectedMode = $(this).data('mode');\n    switchMode(selectedMode);\n  });\n\n  // URL mode functionality\n  $(`#${SIDEBAR_ID}-load-btn`).on('click', () => {\n    const url = ($(`#${SIDEBAR_ID}-url-input`).val() as string).trim();\n    if (url) {\n      updateUrl(url);\n    }\n  });\n\n  $(`#${SIDEBAR_ID}-url-input`).on('keypress', e => {\n    if (e.which === 13) {\n      const url = ($(`#${SIDEBAR_ID}-url-input`).val() as string).trim();\n      if (url) updateUrl(url);\n    }\n  });\n\n  // Paste mode functionality\n  $(`#${SIDEBAR_ID}-render-btn`).on('click', () => {\n    const code = $(`#${SIDEBAR_ID}-paste-textarea`).val() as string;\n    if (code.trim()) {\n      renderPastedCode(code);\n    }\n  });\n\n  $(`#${SIDEBAR_ID}-paste-textarea`).on('input', () => {\n    const code = $(`#${SIDEBAR_ID}-paste-textarea`).val() as string;\n    saveSettings({ ...getSettings(), pasteContent: code });\n  });\n\n  // Initialize based on current mode\n  if (mode === 'paste' && settings.pasteContent) {\n    renderPastedCode(settings.pasteContent);\n  }\n}\n\nfunction updateUrl(url: string) {\n  try {\n    // Add protocol if missing and it looks like a domain\n    if (\n      !url.startsWith('http://') &&\n      !url.startsWith('https://') &&\n      !url.startsWith('./') &&\n      !url.startsWith('/') &&\n      url !== 'about:blank'\n    ) {\n      if (url.includes('.') && !url.includes(' ')) {\n        url = 'https://' + url;\n      }\n    }\n\n    SettingsSchema.parse({ url });\n    setSidebarIframeSrc(url);\n    saveSettings({ ...getSettings(), url });\n    toastr.success('URL updated and loaded');\n  } catch {\n    toastr.error('Invalid URL format');\n  }\n}\n\nfunction switchMode(newMode: 'url' | 'paste') {\n  const settings = getSettings();\n  saveSettings({ ...settings, mode: newMode });\n\n  // Update UI\n  $('.mode-option').removeClass('active');\n  $(`.mode-option[data-mode=\"${newMode}\"]`).addClass('active');\n\n  $('.url-container').toggleClass('active', newMode === 'url');\n  $('.paste-container').toggleClass('active', newMode === 'paste');\n\n  toastr.info(`Switched to ${newMode} mode`);\n}\n\nfunction renderPastedCode(code: string) {\n  try {\n    const fullHtml = buildRuntimeWrappedHtml(code);\n\n    const blob = new Blob([fullHtml], { type: 'text/html' });\n    const blobUrl = URL.createObjectURL(blob);\n\n    setSidebarIframeSrc(blobUrl);\n\n    saveSettings({ ...getSettings(), pasteContent: code });\n\n    toastr.success('Code rendered (Tavern Helper runtime shims enabled)');\n  } catch (error) {\n    console.error('Failed to render pasted code:', error);\n    toastr.error('Failed to render code: ' + (error instanceof Error ? error.message : String(error)));\n  }\n}\n\nfunction toggleSidebar(show?: boolean) {\n  sidebarVisible = typeof show === 'boolean' ? show : !sidebarVisible;\n  $(`#${SIDEBAR_ID}`).toggleClass('visible', sidebarVisible);\n}\n\n// Utility functions for safe button handling\nfunction safeReplaceScriptButtons(\n  buttons: Array<{ name: string; visible: boolean; onclick?: () => void }>,\n  fallbackAction?: () => void,\n): boolean {\n  if (typeof (window as any).replaceScriptButtons === 'function') {\n    try {\n      (window as any).replaceScriptButtons(buttons);\n      console.log('[External HTML Sidebar] Script buttons replaced:', buttons.map(b => b.name).join(', '));\n      return true;\n    } catch (error) {\n      console.error('[External HTML Sidebar] replaceScriptButtons error:', error);\n      if (fallbackAction) {\n        console.log('[External HTML Sidebar] Executing fallback action');\n        fallbackAction();\n      }\n      return false;\n    }\n  }\n\n  console.warn('[External HTML Sidebar] replaceScriptButtons not available');\n  if (fallbackAction) {\n    console.log('[External HTML Sidebar] Executing fallback action');\n    fallbackAction();\n  }\n  return false;\n}\n\nfunction safeEventOn(eventName: string, handler: () => void, fallbackAction?: () => void): boolean {\n  if (typeof (window as any).eventOn === 'function') {\n    try {\n      (window as any).eventOn(eventName, handler);\n      console.log('[External HTML Sidebar] Event handler registered:', eventName);\n      return true;\n    } catch (error) {\n      console.error('[External HTML Sidebar] eventOn error:', error);\n      if (fallbackAction) {\n        console.log('[External HTML Sidebar] Executing fallback action');\n        fallbackAction();\n      }\n      return false;\n    }\n  }\n\n  console.warn('[External HTML Sidebar] eventOn not available');\n  if (fallbackAction) {\n    console.log('[External HTML Sidebar] Executing fallback action');\n    fallbackAction();\n  }\n  return false;\n}\n\nfunction safeGetButtonEvent(buttonName: string, fallbackEventName?: string): string | null {\n  if (typeof (window as any).getButtonEvent === 'function') {\n    try {\n      const eventName = (window as any).getButtonEvent(buttonName);\n      console.log('[External HTML Sidebar] Button event retrieved:', buttonName, '->', eventName);\n      return eventName;\n    } catch (error) {\n      console.error('[External HTML Sidebar] getButtonEvent error:', error);\n      return fallbackEventName || null;\n    }\n  }\n\n  console.warn('[External HTML Sidebar] getButtonEvent not available');\n  return fallbackEventName || null;\n}\n\n// Check dependencies for debugging\nfunction checkDependencies(): Record<string, boolean> {\n  const dependencies = ['jQuery', 'replaceScriptButtons', 'eventOn', 'getButtonEvent'];\n  const results: Record<string, boolean> = {};\n  const missing: string[] = [];\n\n  for (const dep of dependencies) {\n    let available = false;\n    switch (dep) {\n      case 'jQuery':\n        available = typeof $ !== 'undefined';\n        break;\n      case 'replaceScriptButtons':\n        available = typeof (window as any).replaceScriptButtons === 'function';\n        break;\n      case 'eventOn':\n        available = typeof (window as any).eventOn === 'function';\n        break;\n      case 'getButtonEvent':\n        available = typeof (window as any).getButtonEvent === 'function';\n        break;\n    }\n\n    results[dep] = available;\n    if (!available) missing.push(dep);\n  }\n\n  if (missing.length > 0) {\n    console.warn('[External HTML Sidebar] Missing dependencies:', missing.join(', '));\n  } else {\n    console.log('[External HTML Sidebar] All dependencies available');\n  }\n\n  return results;\n}\n\n// Initialization\n$(() => {\n  console.log('[External HTML Sidebar] Script loading...');\n\n  // Check dependencies for debugging\n  checkDependencies();\n\n  installHostBridge();\n  injectCSS();\n  injectHTML();\n\n  const buttonName = 'üåê External Interface';\n\n  // Register button in Tavern Helper with fallback\n  safeReplaceScriptButtons([{ name: buttonName, visible: true }], () => {\n    // Fallback: try to add button manually if replaceScriptButtons fails\n    console.warn('[External HTML Sidebar] Using fallback button placement');\n    const button = $('<button>').text('üåê External Interface').addClass('script-button');\n    button.on('click', () => toggleSidebar());\n    $('#scriptButtons').append(button);\n  });\n\n  // Listen for button click with fallback\n  const buttonEvent = safeGetButtonEvent(buttonName, 'scriptButton:click:external_interface');\n  if (buttonEvent) {\n    safeEventOn(\n      buttonEvent,\n      () => toggleSidebar(),\n      () => {\n        // Fallback: direct click handler\n        console.warn('[External HTML Sidebar] Using fallback button click handler');\n        $('button:contains(\"üåê External Interface\")').on('click', () => {\n          toggleSidebar();\n        });\n      },\n    );\n  } else {\n    console.warn('[External HTML Sidebar] Could not get button event name');\n  }\n\n  // Handle global escape to close\n  $(document).on('keydown', e => {\n    if (e.key === 'Escape' && sidebarVisible) {\n      toggleSidebar(false);\n    }\n  });\n\n  console.log('[External HTML Sidebar] Script loaded successfully');\n});\n\n// Cleanup\n$(window).on('pagehide', () => {\n  console.log('[External HTML Sidebar] Script unloading...');\n\n  $(`#${SIDEBAR_ID}`).remove();\n  deteleportStyle();\n\n  if (currentBlobUrl) {\n    URL.revokeObjectURL(currentBlobUrl);\n    currentBlobUrl = null;\n  }\n\n  try {\n    delete (window.parent as any)[HOST_BRIDGE_KEY];\n  } catch {\n    // ignore\n  }\n\n  console.log('[External HTML Sidebar] Script unloaded');\n});\n","export async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle() {\n  if ($(`head > div[script_id=\"${getScriptId()}\"]`).length > 0) {\n    return;\n  }\n  const $div = $(`<div>`).attr('script_id', getScriptId()).append($(`head > style`, document).clone());\n  $('head').append($div);\n}\n\nexport function deteleportStyle() {\n  $(`head > div[script_id=\"${getScriptId()}\"]`).remove();\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function destroyScriptIdDiv(): void {\n  $(`div[script_id=\"${getScriptId()}\"]`).remove();\n}\n\nexport function reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, new_chat_id => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n"],"names":["z","SIDEBAR_ID","SettingsSchema","object","mode","enum","default","url","string","min","pasteContent","HOST_BRIDGE_KEY","sidebarVisible","currentBlobUrl","escapeInlineScript","source","replaceAll","setSidebarIframeSrc","src","URL","revokeObjectURL","startsWith","$","attr","getSettings","vars","getVariables","type","parse","e","saveSettings","settings","replaceVariables","injectCSS","css","text","appendTo","getScriptId","length","$div","append","document","clone","teleportStyle","injectHTML","html","on","toggleSidebar","newMode","removeClass","addClass","toggleClass","toastr","info","switchMode","this","data","val","trim","updateUrl","which","code","renderPastedCode","includes","success","error","fullHtml","doc","DOMParser","parseFromString","head","createElement","documentElement","insertBefore","body","querySelector","meta","setAttribute","prepend","runtimeShim","JSON","stringify","scriptJquery","textContent","scriptLodash","scriptShim","outerHTML","buildRuntimeWrappedHtml","blob","Blob","createObjectURL","console","Error","message","String","show","log","dependencies","results","missing","dep","available","window","replaceScriptButtons","eventOn","getButtonEvent","push","warn","join","checkDependencies","parent","getGlobal","name","globalThis","getCurrentMessageId","getLastMessageId","chat","SillyTavern","Array","isArray","Math","max","installHostBridge","buttonName","buttons","fallbackAction","map","b","safeReplaceScriptButtons","visible","button","buttonEvent","fallbackEventName","eventName","safeGetButtonEvent","handler","safeEventOn","key","remove"],"ignoreList":[],"sourceRoot":""}