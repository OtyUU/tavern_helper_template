import{default as n}from'https://testingcf.jsdelivr.net/npm/jquery/dist/jquery.min.js?raw/+esm';import{default as e}from'https://testingcf.jsdelivr.net/npm/lodash/lodash.min.js?raw/+esm';const t=z,r='tavern-helper-external-html-sidebar',o=t.z.object({mode:t.z.enum(['url','paste']).default('url'),url:t.z.string().min(1).default('about:blank'),pasteContent:t.z.string().default('')}),a='__tavern_helper_external_html_sidebar_bridge__';let i=!1,l=null;function s(n){return n.replaceAll('</script','<\\/script')}function c(n){l&&(URL.revokeObjectURL(l),l=null),n.startsWith('blob:')&&(l=n),$(`#${r}-iframe`).attr('src',n)}function d(){try{const n=getVariables({type:'script'});return o.parse(n)}catch(n){return o.parse({})}}function p(n){replaceVariables(n,{type:'script'})}function u(){const n=`\n    #${r} {\n      position: fixed;\n      top: 0;\n      right: 0;\n      width: 500px;\n      height: 100vh;\n      background: rgba(29, 33, 40, 0.95);\n      backdrop-filter: blur(5px);\n      border-left: 0.5px solid rgba(0, 0, 0, 0.5);\n      border-top-left-radius: 12px;\n      border-bottom-left-radius: 12px;\n      z-index: 999999;\n      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      transform: translateX(100%);\n      display: flex;\n      flex-direction: column;\n      color: rgba(207, 207, 197, 1);\n      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;\n    }\n\n    #${r}.visible {\n      transform: translateX(0);\n    }\n\n    #${r} .header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      padding: 0 20px;\n      height: 50px;\n      background: rgba(29, 33, 40, 0.98);\n      border-bottom: 0.5px solid rgba(0, 0, 0, 0.8);\n      border-top-left-radius: 12px;\n      flex-shrink: 0;\n    }\n\n    #${r} .header h3 {\n      margin: 0;\n      font-size: 16px;\n      font-weight: 500;\n    }\n\n    #${r} .close-btn {\n      background: rgba(29, 33, 40, 0.6);\n      border: 0.5px solid rgba(0, 0, 0, 0.8);\n      color: rgba(207, 207, 197, 0.9);\n      cursor: pointer;\n      padding: 5px 12px;\n      border-radius: 8px;\n      font-size: 20px;\n      transition: all 0.2s ease;\n      line-height: 1;\n    }\n\n    #${r} .close-btn:hover {\n      background: rgba(40, 45, 52, 0.8);\n      color: #fff;\n    }\n\n    #${r} .content {\n      flex: 1;\n      overflow: hidden;\n      position: relative;\n    }\n\n    #${r} iframe {\n      width: 100%;\n      height: 100%;\n      border: none;\n      background: transparent;\n    }\n\n    #${r} .footer {\n      padding: 10px 15px;\n      background: rgba(29, 33, 40, 0.98);\n      border-top: 0.5px solid rgba(0, 0, 0, 0.8);\n      display: flex;\n      gap: 8px;\n      flex-shrink: 0;\n    }\n\n    #${r} .url-input {\n      flex: 1;\n      background: rgba(0, 0, 0, 0.3);\n      border: 0.5px solid rgba(255, 255, 255, 0.1);\n      border-radius: 6px;\n      color: #fff;\n      padding: 6px 10px;\n      font-size: 12px;\n      outline: none;\n    }\n\n    #${r} .load-btn {\n      background: #4a5568;\n      border: none;\n      border-radius: 6px;\n      color: #fff;\n      padding: 6px 12px;\n      font-size: 12px;\n      cursor: pointer;\n      transition: background 0.2s;\n    }\n\n    #${r} .load-btn:hover {\n      background: #2d3748;\n    }\n\n    #${r} .mode-toggle {\n      display: flex;\n      background: rgba(0, 0, 0, 0.3);\n      border-radius: 6px;\n      padding: 2px;\n      margin-bottom: 8px;\n    }\n\n    #${r} .mode-option {\n      flex: 1;\n      background: transparent;\n      border: none;\n      color: #aaa;\n      padding: 6px 12px;\n      border-radius: 4px;\n      font-size: 12px;\n      cursor: pointer;\n      transition: all 0.2s;\n    }\n\n    #${r} .mode-option.active {\n      background: #4a5568;\n      color: #fff;\n    }\n\n    #${r} .mode-content {\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n      flex: 1;\n    }\n\n    #${r} .paste-container {\n      display: none;\n      flex-direction: column;\n      gap: 8px;\n    }\n\n    #${r} .paste-container.active {\n      display: flex;\n    }\n\n    #${r} .url-container {\n      display: none;\n      gap: 8px;\n    }\n\n    #${r} .url-container.active {\n      display: flex;\n    }\n\n    #${r} .paste-textarea {\n      flex: 1;\n      background: rgba(0, 0, 0, 0.3);\n      border: 0.5px solid rgba(255, 255, 255, 0.1);\n      border-radius: 6px;\n      color: #fff;\n      padding: 8px;\n      font-size: 12px;\n      font-family: 'Courier New', monospace;\n      resize: vertical;\n      min-height: 60px;\n      outline: none;\n    }\n\n    #${r} .paste-textarea:focus {\n      border-color: #4a5568;\n    }\n\n    #${r} .render-btn {\n      background: #4a5568;\n      border: none;\n      border-radius: 6px;\n      color: #fff;\n      padding: 6px 12px;\n      font-size: 12px;\n      cursor: pointer;\n      transition: background 0.2s;\n    }\n\n    #${r} .render-btn:hover {\n      background: #2d3748;\n    }\n  `;$('<style>').text(n).appendTo('head'),function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const n=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(n)}()}function b(){if($(`#${r}`).length>0)return;const n=d(),e=n.mode||'url',t=`\n    <div id="${r}">\n      <div class="header">\n        <div style="display: flex; align-items: center; gap: 8px;">\n          <span style="font-size: 18px;">üåê</span>\n          <h3>External Interface</h3>\n        </div>\n        <button class="close-btn" id="${r}-close" title="Close">√ó</button>\n      </div>\n      <div class="content">\n        <iframe id="${r}-iframe" src="${n.url}"></iframe>\n      </div>\n      <div class="footer">\n        <div class="mode-toggle">\n          <button class="mode-option ${'url'===e?'active':''}" data-mode="url">URL</button>\n          <button class="mode-option ${'paste'===e?'active':''}" data-mode="paste">Paste Code</button>\n        </div>\n        <div class="mode-content">\n          <div class="url-container ${'url'===e?'active':''}">\n            <input type="text" class="url-input" id="${r}-url-input" value="${'about:blank'===n.url?'':n.url}" placeholder="Enter HTML URL (e.g. ./panel/index.html)...">\n            <button class="load-btn" id="${r}-load-btn">Load</button>\n          </div>\n          <div class="paste-container ${'paste'===e?'active':''}">\n            <textarea class="paste-textarea" id="${r}-paste-textarea" placeholder="Paste your HTML/CSS/JS code here...">${n.pasteContent}</textarea>\n            <button class="render-btn" id="${r}-render-btn">Render</button>\n          </div>\n        </div>\n      </div>\n    </div>\n  `;$('body').append(t),$(`#${r}-close`).on('click',()=>x(!1)),$('.mode-option').on('click',function(){!function(n){const e=d();p({...e,mode:n}),$('.mode-option').removeClass('active'),$(`.mode-option[data-mode="${n}"]`).addClass('active'),$('.url-container').toggleClass('active','url'===n),$('.paste-container').toggleClass('active','paste'===n),toastr.info(`Switched to ${n} mode`)}($(this).data('mode'))}),$(`#${r}-load-btn`).on('click',()=>{const n=$(`#${r}-url-input`).val().trim();n&&f(n)}),$(`#${r}-url-input`).on('keypress',n=>{if(13===n.which){const n=$(`#${r}-url-input`).val().trim();n&&f(n)}}),$(`#${r}-render-btn`).on('click',()=>{const n=$(`#${r}-paste-textarea`).val();n.trim()&&g(n)}),$(`#${r}-paste-textarea`).on('input',()=>{const n=$(`#${r}-paste-textarea`).val();p({...d(),pasteContent:n})}),'paste'===e&&n.pasteContent&&g(n.pasteContent)}function f(n){try{n.startsWith('http://')||n.startsWith('https://')||n.startsWith('./')||n.startsWith('/')||'about:blank'===n||n.includes('.')&&!n.includes(' ')&&(n='https://'+n),o.parse({url:n}),c(n),p({...d(),url:n}),toastr.success('URL updated and loaded')}catch{toastr.error('Invalid URL format')}}function g(t){try{const r=function(t){const r=(new DOMParser).parseFromString(t,'text/html');if(!r.head){const n=r.createElement('head');r.documentElement.insertBefore(n,r.body)}if(!r.head.querySelector('meta[charset]')){const n=r.createElement('meta');n.setAttribute('charset','UTF-8'),r.head.prepend(n)}const o=`\n(() => {\n  const BRIDGE_KEY = ${JSON.stringify(a)};\n  const bridge = (() => {\n    try {\n      return window.parent && window.parent[BRIDGE_KEY];\n    } catch {\n      return undefined;\n    }\n  })();\n\n  const missing = name => () => {\n    throw new Error(\n      '[external-html-sidebar] Missing runtime global: ' +\n        name +\n        '. This page must be rendered inside SillyTavern with Tavern Helper + external-html-sidebar.',\n    );\n  };\n\n  const getGlobal = name => (bridge && bridge.getGlobal ? bridge.getGlobal(name) : undefined);\n\n  const bridgeFn = name => (...args) => {\n    const fn = getGlobal(name);\n    if (typeof fn !== 'function') return missing(name)();\n    return fn(...args);\n  };\n\n  const syncGlobal = name => {\n    try {\n      const value = getGlobal(name);\n      if (typeof value !== 'undefined' && typeof window[name] === 'undefined') {\n        window[name] = value;\n      }\n    } catch {\n      // ignore\n    }\n  };\n\n  if (typeof window.waitGlobalInitialized !== 'function') {\n    window.waitGlobalInitialized = async name => {\n      await bridgeFn('waitGlobalInitialized')(name);\n      syncGlobal(name);\n    };\n  }\n  if (typeof window.getAllVariables !== 'function') window.getAllVariables = bridgeFn('getAllVariables');\n  if (typeof window.getVariables !== 'function') window.getVariables = bridgeFn('getVariables');\n  if (typeof window.replaceVariables !== 'function') window.replaceVariables = bridgeFn('replaceVariables');\n  if (typeof window.triggerSlash !== 'function') window.triggerSlash = bridgeFn('triggerSlash');\n  if (typeof window.eventOn !== 'function') window.eventOn = bridgeFn('eventOn');\n  if (typeof window.getButtonEvent !== 'function') window.getButtonEvent = bridgeFn('getButtonEvent');\n  if (typeof window.replaceScriptButtons !== 'function') window.replaceScriptButtons = bridgeFn('replaceScriptButtons');\n\n  if (typeof window.errorCatched !== 'function') {\n    window.errorCatched = fn => (...args) => {\n      try {\n        const result = fn(...args);\n        if (result && typeof result.then === 'function') {\n          return result.catch(err => {\n            console.error(err);\n            throw err;\n          });\n        }\n        return result;\n      } catch (err) {\n        console.error(err);\n        throw err;\n      }\n    };\n  }\n\n  syncGlobal('SillyTavern');\n  syncGlobal('toastr');\n  syncGlobal('Mvu');\n  syncGlobal('tavern_events');\n  syncGlobal('z');\n  syncGlobal('gsap');\n  syncGlobal('YAML');\n\n  if (typeof window.getCurrentMessageId !== 'function') {\n    window.getCurrentMessageId = () => {\n      try {\n        if (bridge && typeof bridge.getCurrentMessageId === 'function') {\n          return bridge.getCurrentMessageId();\n        }\n      } catch {\n        // ignore\n      }\n\n      try {\n        const chat = window.SillyTavern && window.SillyTavern.chat;\n        if (Array.isArray(chat)) return Math.max(0, chat.length - 1);\n      } catch {\n        // ignore\n      }\n\n      return 0;\n    };\n  }\n})();\n`,i=r.createElement('script');i.textContent=s(n);const l=r.createElement('script');l.textContent=s(e);const c=r.createElement('script');return c.textContent=s(o),r.head.prepend(i,l,c),`<!DOCTYPE html>\n${r.documentElement.outerHTML}`}(t),o=new Blob([r],{type:'text/html'});c(URL.createObjectURL(o)),p({...d(),pasteContent:t}),toastr.success('Code rendered (Tavern Helper runtime shims enabled)')}catch(n){console.error('Failed to render pasted code:',n),toastr.error('Failed to render code: '+(n instanceof Error?n.message:String(n)))}}function x(n){i='boolean'==typeof n?n:!i,$(`#${r}`).toggleClass('visible',i)}$(()=>{console.log('[External HTML Sidebar] Script loading...'),function(){const n=['jQuery','replaceScriptButtons','eventOn','getButtonEvent'],e={},t=[];for(const r of n){let n=!1;switch(r){case'jQuery':n='undefined'!=typeof $;break;case'replaceScriptButtons':n='function'==typeof window.replaceScriptButtons;break;case'eventOn':n='function'==typeof window.eventOn;break;case'getButtonEvent':n='function'==typeof window.getButtonEvent}e[r]=n,n||t.push(r)}t.length>0?console.warn('[External HTML Sidebar] Missing dependencies:',t.join(', ')):console.log('[External HTML Sidebar] All dependencies available')}(),function(){try{if(!window.parent)return;window.parent[a]={getGlobal:n=>globalThis[n],getCurrentMessageId:()=>{const n=globalThis.getLastMessageId;if('function'==typeof n)return n();const e=globalThis.SillyTavern?.chat;return Array.isArray(e)?Math.max(0,e.length-1):0}}}catch{}}(),u(),b();const n='üåê External Interface';!function(n,e){if('function'==typeof window.replaceScriptButtons)try{return window.replaceScriptButtons(n),console.log('[External HTML Sidebar] Script buttons replaced:',n.map(n=>n.name).join(', ')),!0}catch(n){return console.error('[External HTML Sidebar] replaceScriptButtons error:',n),e&&(console.log('[External HTML Sidebar] Executing fallback action'),e()),!1}console.warn('[External HTML Sidebar] replaceScriptButtons not available'),e&&(console.log('[External HTML Sidebar] Executing fallback action'),e())}([{name:n,visible:!0}],()=>{console.warn('[External HTML Sidebar] Using fallback button placement');const n=$('<button>').text('üåê External Interface').addClass('script-button');n.on('click',()=>x()),$('#scriptButtons').append(n)});const e=function(n,e){if('function'==typeof window.getButtonEvent)try{const e=window.getButtonEvent(n);return console.log('[External HTML Sidebar] Button event retrieved:',n,'->',e),e}catch(n){return console.error('[External HTML Sidebar] getButtonEvent error:',n),e||null}return console.warn('[External HTML Sidebar] getButtonEvent not available'),e||null}(n,'scriptButton:click:external_interface');e?function(n,e,t){if('function'==typeof window.eventOn)try{return window.eventOn(n,e),console.log('[External HTML Sidebar] Event handler registered:',n),!0}catch(n){return console.error('[External HTML Sidebar] eventOn error:',n),t&&(console.log('[External HTML Sidebar] Executing fallback action'),t()),!1}console.warn('[External HTML Sidebar] eventOn not available'),t&&(console.log('[External HTML Sidebar] Executing fallback action'),t())}(e,()=>x(),()=>{console.warn('[External HTML Sidebar] Using fallback button click handler'),$('button:contains("üåê External Interface")').on('click',()=>{x()})}):console.warn('[External HTML Sidebar] Could not get button event name'),$(document).on('keydown',n=>{'Escape'===n.key&&i&&x(!1)}),console.log('[External HTML Sidebar] Script loaded successfully')}),$(window).on('pagehide',()=>{console.log('[External HTML Sidebar] Script unloading...'),$(`#${r}`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove(),l&&(URL.revokeObjectURL(l),l=null);try{delete window.parent[a]}catch{}console.log('[External HTML Sidebar] Script unloaded')});
//# sourceMappingURL=index.js.map